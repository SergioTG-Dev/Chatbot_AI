version: '3.8'
services:
  backend-api:
    # Example: build the backend API from the repo
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: backend-api
    environment:
      - PORT=8000
    ports:
      - "8000:8000"

  action-server:
    # Actions run the custom actions module
    image: rasa/rasa-sdk:3.3.0
    container_name: rasa-action-server
    volumes:
      - ./src/rasa-chat:/app/actions:ro
    environment:
      - FASTAPI_URL=http://backend-api:8000
    ports:
      - "5055:5055"

  rasa:
    image: rasa/rasa:3.3.0-full
    container_name: rasa
    command: ["run", "-m", "models", "--enable-api", "--cors", "*"]
    environment:
      - ACTION_ENDPOINT_URL=http://action-server:5055/webhook
      - FASTAPI_URL=http://backend-api:8000
    ports:
      - "5005:5005"
    depends_on:
      - action-server
      - backend-api

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ../../prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

# Notes:
# - This is an example composition to run Rasa, the action server and the
#   backend API together for local integration testing. It assumes you have
#   Dockerfiles for the backend API under backend/api/.
# - Set `FASTAPI_URL` and `ACTION_ENDPOINT_URL` appropriately for your
#   environment. Supabase is an external service and is not included here.